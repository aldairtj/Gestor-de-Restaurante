<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura - Restaurante Elegante</title>
    <style>
        /* Variables CSS basadas en la paleta proporcionada */
        :root {
            /* Colores primarios */
            --primary: rgb(141 77 45);
            --primary-container: rgb(255 219 204);
            --on-primary: rgb(255 255 255);
            --on-primary-container: rgb(112 55 24);
            --primary-fixed-dim: rgb(255 182 147);
            
            /* Colores secundarios */
            --secondary: rgb(118 87 73);
            --secondary-container: rgb(255 219 204);
            --on-secondary: rgb(255 255 255);
            --on-secondary-container: rgb(92 64 51);
            
            /* Colores terciarios */
            --tertiary: rgb(102 95 49);
            --tertiary-container: rgb(237 228 169);
            --on-tertiary: rgb(255 255 255);
            --on-tertiary-container: rgb(77 72 28);
            
            /* Colores de fondo y superficie */
            --background: rgb(255 248 246);
            --surface: rgb(255 248 246);
            --surface-container: rgb(252 234 227);
            --surface-container-high: rgb(246 229 222);
            --surface-container-highest: rgb(240 223 216);
            --surface-variant: rgb(244 222 213);
            
            /* Colores de texto */
            --on-background: rgb(34 26 22);
            --on-surface: rgb(34 26 22);
            --on-surface-variant: rgb(82 68 61);
            
            /* Colores de acento y estado */
            --outline: rgb(133 115 108);
            --outline-variant: rgb(215 194 185);
            
            /* Colores de éxito y error */
            --success: rgb(46 125 50);
            --error: rgb(186 26 26);
            --error-container: rgb(255 218 214);
            
            /* Sombras y efectos */
            --shadow: rgba(0 0 0 / 0.2);
            --scrim: rgba(0 0 0 / 0.5);
        }
        
        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        
        body {
            padding: 20px;
            color: var(--on-surface);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Contenedor principal */
        .factura-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            background: var(--surface);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow);
            overflow: hidden;
            position: relative;
        }
        
        /* Encabezado con gradiente */
        .factura-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--on-primary);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .factura-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }
        
        .restaurant-name {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: 1px;
            color: var(--on-primary);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .restaurant-subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .factura-id {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }
        
        /* Información de la factura */
        .factura-info {
            padding: 25px;
            background: var(--surface-container-high);
            border-bottom: 2px solid var(--outline-variant);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--outline-variant);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-item strong {
            color: var(--primary);
        }
        
        .info-item span {
            font-weight: 500;
            color: var(--on-surface-variant);
        }
        
        /* Tabla de productos */
        .productos-table {
            padding: 25px;
        }
        
        .table-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--on-primary-container) 100%);
            color: var(--on-primary);
            padding: 15px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .table-body {
            border: 1px solid var(--outline-variant);
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid var(--outline-variant);
            transition: background 0.3s;
        }
        
        .table-row:hover {
            background: var(--surface-container);
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Sección de totales */
        .totales-section {
            padding: 25px;
            background: linear-gradient(135deg, var(--surface-container) 0%, var(--surface-container-high) 100%);
            border-top: 2px solid var(--outline-variant);
        }
        
        .totales-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 400px;
            margin-left: auto;
        }
        
        .total-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            font-weight: 500;
        }
        
        .total-item.total-final {
            background: linear-gradient(135deg, var(--tertiary) 0%, var(--on-tertiary-container) 100%);
            color: var(--on-tertiary);
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        /* Código QR */
        .qr-section {
            padding: 25px;
            text-align: center;
            background: var(--surface-container-high);
            border-top: 2px solid var(--outline-variant);
        }
        
        .qr-container {
            max-width: 300px;
            margin: 0 auto 20px;
            padding: 20px;
            background: var(--surface);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow);
        }
        
        .qr-placeholder {
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            background: linear-gradient(45deg, var(--surface-container-high) 25%, transparent 25%, transparent 75%, var(--surface-container-high) 75%),
                        linear-gradient(45deg, var(--surface-container-high) 25%, transparent 25%, transparent 75%, var(--surface-container-high) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--on-surface-variant);
            font-size: 0.9rem;
        }
        
        /* Pie de página */
        .factura-footer {
            padding: 25px;
            background: var(--primary);
            color: var(--on-primary);
            text-align: center;
        }
        
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .footer-item h4 {
            color: var(--primary-fixed-dim);
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        /* Botones de acción */
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--on-primary-container) 100%);
            color: var(--on-primary);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(141, 77, 45, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--tertiary) 0%, var(--on-tertiary-container) 100%);
            color: var(--on-tertiary);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 95, 49, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--on-secondary-container) 100%);
            color: var(--on-secondary);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(118, 87, 73, 0.3);
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        /* Estilos para impresión */
        @media print {
            body {
                background: var(--surface);
                padding: 0;
            }
            
            .factura-container {
                box-shadow: none;
                margin: 0;
                border-radius: 0;
                max-width: 100%;
            }
            
            .no-print {
                display: none !important;
            }
            
            .action-buttons {
                display: none;
            }
            
            @page {
                margin: 20mm;
                size: A4;
            }
            
            /* Forzar saltos de página evitados */
            .table-row, .total-item, .qr-container {
                page-break-inside: avoid;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .factura-container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .restaurant-name {
                font-size: 2rem;
            }
            
            .table-header, .table-row {
                grid-template-columns: 1.5fr 0.8fr 1fr 1fr;
                font-size: 0.9rem;
                padding: 10px;
            }
            
            .totales-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                position: static;
                justify-content: center;
                margin-top: 20px;
                flex-wrap: wrap;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
        
        /* Estados */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--on-surface-variant);
        }
        
        .loading-spinner {
            border: 4px solid var(--surface-container);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 60px 20px;
            color: var(--error);
        }
        
        .error-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        /* Estilos adicionales */
        .highlight {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--primary-container);
            color: var(--on-primary-container);
        }
        
        .even {
            background-color: var(--surface-container-high);
        }
        
        .odd {
            background-color: var(--surface);
        }
    </style>
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Botones de acción (no se imprimen) -->
    <div class="action-buttons no-print">
        <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Imprimir Factura
        </button>
        <button class="btn btn-success" onclick="enviarPorCorreo()">
            <i class="fas fa-envelope"></i> Enviar por Email
        </button>
        <button class="btn btn-secondary" onclick="window.close()">
            <i class="fas fa-times"></i> Cerrar
        </button>
    </div>
    
    <!-- Contenedor principal de la factura -->
    <div class="factura-container fade-in">
        <div class="factura-header">
            <div class="factura-id">FACTURA</div>
            <h1 class="restaurant-name"><i class="fas fa-utensils"></i> RESTAURANTE ELEGANTE</h1>
            <p class="restaurant-subtitle">SISTEMA DE FACTURACIÓN ELECTRÓNICA</p>
            <p class="restaurant-subtitle" style="opacity: 0.7; font-size: 0.9rem;">
                <i class="fas fa-star"></i> "Exquisita cocina, servicio excepcional" <i class="fas fa-star"></i>
            </p>
        </div>
        
        <div id="facturaContent" class="loading">
            <div class="loading-spinner"></div>
            <p>Cargando factura...</p>
        </div>
    </div>

    <script>
        // Configuración global
        const API_BASE_URL = window.location.origin.includes('localhost') 
            ? 'http://localhost:5034/api' 
            : '/api';
        
        // Obtener parámetros de la URL
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-PE', {
                style: 'currency',
                currency: 'PEN',
                minimumFractionDigits: 2
            }).format(amount);
        }
        
        // Formatear fecha
        function formatDate(dateString) {
            const date = dateString ? new Date(dateString) : new Date();
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Generar código de autorización
        function generateAuthorizationCode(facturaId) {
            const timestamp = Date.now().toString();
            const random = Math.random().toString(36).substr(2, 6).toUpperCase();
            return facturaId ? `FACT-${facturaId}-${timestamp.slice(-8)}-${random}` : `TEMP-${timestamp.slice(-8)}-${random}`;
        }
        
        // Mostrar estado de carga
        function showLoading(message = 'Cargando factura...') {
            const content = document.getElementById('facturaContent');
            content.className = 'loading';
            content.innerHTML = `
                <div class="loading-spinner"></div>
                <p>${message}</p>
            `;
        }
        
        // Mostrar error
        function showError(message, details = '') {
            const content = document.getElementById('facturaContent');
            content.className = 'error';
            content.innerHTML = `
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Error al cargar la factura</h3>
                <p>${message}</p>
                ${details ? `<p><small>${details}</small></p>` : ''}
                <button onclick="retryLoading()" class="btn btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> Reintentar
                </button>
            `;
        }
        
        // Reintentar carga
        function retryLoading() {
            cargarFactura();
        }
        
        // Cargar datos de la factura
        async function cargarFactura() {
            const pedidoId = getQueryParam('pedidoId');
            const facturaId = getQueryParam('facturaId');
            
            if (!pedidoId) {
                showError('No se especificó el número de pedido');
                return;
            }
            
            showLoading('Obteniendo datos del pedido...');
            
            try {
                // Cargar datos del pedido y detalles
                const [pedidoResponse, detallesResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/pedido/${pedidoId}`),
                    fetch(`${API_BASE_URL}/detallepedido/pedido/${pedidoId}`)
                ]);
                
                if (!pedidoResponse.ok) {
                    throw new Error(`Error ${pedidoResponse.status} al cargar el pedido`);
                }
                
                const pedidoData = await pedidoResponse.json();
                const detallesData = await detallesResponse.json();
                
                // Calcular total
                const total = detallesData.reduce((sum, detalle) => {
                    return sum + (detalle.CANTIDAD || 0) * (detalle.PRECIO_UNITARIO || 0);
                }, 0);
                
                // Cargar información adicional si es necesario
                let mesaInfo = {};
                let meseroInfo = {};
                
                try {
                    if (pedidoData.ID_MESA) {
                        const mesaResponse = await fetch(`${API_BASE_URL}/mesa/${pedidoData.ID_MESA}`);
                        if (mesaResponse.ok) {
                            mesaInfo = await mesaResponse.json();
                        }
                    }
                    
                    if (pedidoData.ID_MESERO) {
                        const meseroResponse = await fetch(`${API_BASE_URL}/mesero/${pedidoData.ID_MESERO}`);
                        if (meseroResponse.ok) {
                            meseroInfo = await meseroResponse.json();
                        }
                    }
                } catch (error) {
                    console.warn('Error cargando información adicional:', error);
                }
                
                // Generar la factura
                generarFactura({
                    pedidoId,
                    facturaId,
                    pedido: pedidoData,
                    detalles: detallesData,
                    total,
                    mesaInfo,
                    meseroInfo
                });
                
                // Auto-imprimir después de un breve retraso
                setTimeout(() => {
                    if (confirm('¿Desea imprimir la factura ahora?')) {
                        window.print();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error completo:', error);
                showError('No se pudo cargar la factura', error.message);
            }
        }
        
        // Generar contenido de la factura
        function generarFactura(data) {
            const {
                pedidoId,
                facturaId,
                pedido,
                detalles,
                total,
                mesaInfo,
                meseroInfo
            } = data;
            
            const content = document.getElementById('facturaContent');
            content.className = '';
            
            // Calcular IGV (18%)
            const subtotal = total;
            const igv = total * 0.18;
            const totalConIgv = total + igv;
            
            // Generar tabla de detalles
            let detallesHtml = '';
            if (detalles && detalles.length > 0) {
                detallesHtml = detalles.map((detalle, index) => `
                    <div class="table-row ${index % 2 === 0 ? 'even' : 'odd'}">
                        <div>${detalle.NOMBRE || `Plato #${detalle.ID_PLATO}`}</div>
                        <div class="text-center">${detalle.CANTIDAD || 1}</div>
                        <div class="text-right">${formatCurrency(detalle.PRECIO_UNITARIO || 0)}</div>
                        <div class="text-right">${formatCurrency((detalle.CANTIDAD || 1) * (detalle.PRECIO_UNITARIO || 0))}</div>
                    </div>
                `).join('');
            } else {
                detallesHtml = `
                    <div class="table-row">
                        <div colspan="4" class="text-center">No hay detalles disponibles</div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <!-- Información de la factura -->
                <div class="factura-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <strong><i class="far fa-calendar"></i> Fecha y hora:</strong>
                            <span>${formatDate(pedido.FECHA_PEDIDO)}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-hashtag"></i> Número de pedido:</strong>
                            <span class="highlight">#${pedidoId}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-chair"></i> Mesa:</strong>
                            <span>${mesaInfo.NUMERO ? `Mesa ${mesaInfo.NUMERO}` : `#${pedido.ID_MESA}`}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-user-tie"></i> Mesero:</strong>
                            <span>${meseroInfo.NOMBRE || `Mesero #${pedido.ID_MESERO}`}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-clipboard-check"></i> Estado del pedido:</strong>
                            <span class="status-badge">${pedido.ESTADO || 'Completado'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de productos -->
                <div class="productos-table">
                    <div class="table-header">
                        <div>Descripción del producto</div>
                        <div class="text-center">Cantidad</div>
                        <div class="text-right">Precio unitario</div>
                        <div class="text-right">Subtotal</div>
                    </div>
                    <div class="table-body">
                        ${detallesHtml}
                    </div>
                </div>
                
                <!-- Totales -->
                <div class="totales-section">
                    <div class="totales-grid">
                        <div class="total-item">
                            <span>Subtotal:</span>
                            <span>${formatCurrency(subtotal)}</span>
                        </div>
                        <div class="total-item">
                            <span>IGV (18%):</span>
                            <span>${formatCurrency(igv)}</span>
                        </div>
                        <div class="total-item total-final">
                            <span>TOTAL A PAGAR:</span>
                            <span>${formatCurrency(totalConIgv)}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Código QR -->
                <div class="qr-section">
                    <div class="qr-container">
                        <h3><i class="fas fa-qrcode"></i> COMPROBANTE ELECTRÓNICO</h3>
                        <div class="qr-placeholder">
                            <div style="text-align: center;">
                                <i class="fas fa-qrcode fa-3x" style="color: var(--on-surface-variant); margin-bottom: 10px;"></i>
                                <div>Código QR</div>
                                <small>(Generado electrónicamente)</small>
                            </div>
                        </div>
                        <p style="font-family: monospace; font-size: 0.8rem; color: var(--on-surface-variant);">
                            ${generateAuthorizationCode(facturaId)}
                        </p>
                    </div>
                </div>
                
                <!-- Pie de página -->
                <div class="factura-footer">
                    <div class="footer-grid">
                        <div class="footer-item">
                            <h4><i class="fas fa-map-marker-alt"></i> Dirección</h4>
                            <p>Av. Principal 123<br>Centro Comercial "El Elegante"<br>Lima, Perú</p>
                        </div>
                        <div class="footer-item">
                            <h4><i class="fas fa-phone"></i> Contacto</h4>
                            <p>Tel: (01) 123-4567<br>WhatsApp: 987-654-321<br>info@restauranteelegante.com</p>
                        </div>
                        <div class="footer-item">
                            <h4><i class="fas fa-file-invoice"></i> Información Legal</h4>
                            <p>RUC: 20123456789<br>Facturación Electrónica<br>Autorizado por SUNAT</p>
                        </div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
                    <p style="font-size: 0.9rem; opacity: 0.8;">
                        <i class="fas fa-info-circle"></i> Esta factura es un comprobante de pago válido para efectos tributarios.<br>
                        <small>Generada el ${new Date().toLocaleString()}</small>
                    </p>
                </div>
            `;
        }
        
        // Función para enviar por correo (simulada)
        function enviarPorCorreo() {
            const pedidoId = getQueryParam('pedidoId');
            const email = prompt('Ingrese el correo electrónico para enviar la factura:');
            
            if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert(`Factura del pedido #${pedidoId} será enviada a: ${email}\n\n(Esta es una simulación - en producción se integraría con un servicio de email)`);
            } else if (email) {
                alert('Por favor ingrese un correo electrónico válido.');
            }
        }
        
        // Cierre automático después de imprimir
        window.onafterprint = function() {
            setTimeout(() => {
                if (confirm('¿Desea cerrar la ventana de la factura?')) {
                    window.close();
                }
            }, 500);
        };
        
        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Añadir efectos visuales
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease';
                document.body.style.opacity = '1';
            }, 100);
            
            // Cargar la factura
            cargarFactura();
            
            // Tecla ESC para cerrar
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    window.close();
                }
            });
        });
    </script>
</body>
</html>